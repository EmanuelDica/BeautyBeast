@namespace BeautyBeastApp.Dialogs
@inject BeautyBeastApp.Services.PostRepository PostRepository

<MudDialog>
    <DialogContent>
        <MudFileUpload T="IBrowserFile" Accept=".png, .jpg" FilesChanged="UploadFiles2" MaximumFileCount="100">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled"
                        Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.CloudUpload">
                    Search for Images
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>

@if (files != null)
{
    <MudList T="string">
        @foreach (var file in files)
        {
            <MudListItem Icon="@Icons.Material.Filled.AttachFile">
                @file.Name <code>@file.Size bytes</code>
            </MudListItem>
        }
    </MudList>
}

@code {

    IList<IBrowserFile> files = new List<IBrowserFile>();

    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = default!;

    private async Task Submit()
    {
        if (!files.Any())
        {
            return; // Prevent submission with no files
        }

        // Create a new Post object
        var post = new BeautyBeastApp.Models.Post
        {
            MediaUrls = files.Select(f => f.Name).ToList(), // Replace with actual file URLs after upload
            DatePosted = DateTime.UtcNow,
            ArtistId = 1 // Replace with the current user's ArtistId
        };

        // Save the post using PostRepository
        await PostRepository.AddPostAsync(post);

        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel() => MudDialog.Cancel();

     private void UploadFiles2(IBrowserFile file)
    {
        files.Add(file);
        //TODO upload the files to the server
    }
}